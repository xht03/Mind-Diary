---
title: "条件随机场"
author: "xht03"
date: 2025-05-25 16:09:20
tags:
- labs
- notes
categories:
- Deep Learning
header-includes:
- \usepackage{xeCJK}
---

## 标签偏置问题


## 概率无向图模型

无向概率图模型（Undirected Probabilistic Graphical Model），又称**马尔可夫随机场（Markov Random Field, MRF）**，是一个可以由无向图表示的联合概率分布。

设联合概率分布 $P(Y), Y \in \mathcal{Y}$ 是一组随机变量。由无向图 $G = (V, E)$ 表示概率分布 $P(Y)$ 。即：在图 $G$ 中，结点 $v\in V$ 表示一个随机变量 $Y_v$ ，则 $Y = \{Y_v | v \in V\} = (Y_v)_{v \in V}$ ；边 $e \in E$ 表示随机变量之间的概率依赖关系。

对于一个给定的联合分布 $P(Y)$ 和表示它的无向图 $G$ ，我们先定义随机变量间的**成对马尔可夫性**、**局部马尔可夫性**和**全局马尔可夫性**。

1. 成对马尔可夫性：
   
   设 $u$ 和 $v$ 是图 $G$ 中的两个结点，$Y_u$ 和 $Y_v$ 分别是它们对应的随机变量。其他所有结点为 $O$ ，则成对马尔可夫性是指在给定 $Y_O$ 的条件下，$Y_u$ 和 $Y_v$ 条件独立，即：

    $$
    P(Y_u, Y_v | Y_O) = P(Y_u | Y_O) P(Y_v | Y_O)
    $$

2. 局部马尔可夫性：
   
   设 $v$ 是图 $G$ 中的一个结点，$Y_v$ 是它对应的随机变量。$W$ 是与 $v$ 有边连接的所有结点，$O$ 是除 $v$ 和 $W$ 之外的所有结点，则局部马尔可夫性是指在给定 $Y_W$ 的条件下，$Y_v$ 和 $Y_O$ 条件独立，即：

   $$
   P(Y_v, Y_O | Y_W) = P(Y_v | Y_W) P(Y_O | Y_W)
   $$

   在 $P(Y_O | Y_W)>0$ 时，等价为： 

   $$
   P(Y_v | Y_W, Y_O) = P(Y_v | Y_W)
   $$

3. 全局马尔可夫性：
    设 $A$ 和 $B$ 是图 $G$ 中的两个结点集，被结点集合 $C$ 分开，$Y_A$ 、$Y_B$ 和 $Y_C$ 分别是它们对应的随机变量。则全局马尔可夫性是指在给定 $Y_C$ 的条件下，$Y_A$ 和 $Y_B$ 条件独立，即：
    
    $$
    P(Y_A, Y_B | Y_C) = P(Y_A | Y_C) P(Y_B | Y_C)
    $$

值得一提的是，成对马尔可夫性、局部马尔可夫性和全局马尔可夫性是**等价的**。也就是说，如果一个联合分布满足其中一个条件，则它也满足其他两个条件。

现在，我们可以给出无向概率图模型的定义：

设有联合分布概率 $P(Y)$ ，由无向图 $G=(V,E)$ 表示。如果它满足成对马尔可夫性、局部马尔可夫性和全局马尔可夫性，则称 $P(Y)$ 是一个无向概率图模型（Undirected Probabilistic Graphical Model），或称马尔可夫随机场（Markov Random Field, MRF）。

## 条件随机场

条件随机场（Conditional Random Field, CRF）是在给定随机变量 $X$ 的条件下，另一随机变量 $Y$ 的马尔可夫随机场。

设 $X$ 与 $Y$ 是随机变量， $P(Y|X)$ 是给定 $X$ 条件下 $Y$ 的联合概率分布。若随机变量 $Y$ 是由无向图 $G=(V,E)$ 表示的马尔可夫随机场，即：

$$
P(Y_v|X, Y_w, w \neq v) = P(Y_v|X, Y_W, w \sim v), \quad \forall v
$$

则称 $P(Y|X)$ 是一个条件随机场（Conditional Random Field, CRF）。

其中：

- $w \sim v$ 表示在图 $G$ 中与 $v$ 之间有边连接的所有结点 $w$ 。

- $w \neq v$ 表示除 $v$ 之外的所有结点 $w$ 。

注意到，在条件随机场的定义中，$X$ 和 $Y$ 不必有相同的结构。但在现实中，$X$ 和 $Y$ 往往有相同结构（还通常是线性链）。

## 线性链条件随机场

设 $X = (X_1, X_2, \ldots, X_n)$ ，$Y = (Y_1, Y_2, \ldots, Y_n)$ 均为线性链表示的随机变量序列。若 $P(Y|X)$ 是一个条件随机场，即满足马尔可夫性

$$
P(Y_i|X, Y_1, \cdots, Y_{i-1}, Y_{i+1}, \cdots, Y_n) = P(Y_i|X, Y_{i-1}, Y_{i+1}), \quad \forall i \text{（在} i = 1,n \text{时只考虑单边}
$$

则称 $P(Y|X)$ 是一个线性链条件随机场（Linear Chain Conditional Random Field）。

在标注问题中，$X$ 通常是输入观测序列，$Y$ 是输出标记序列。

![](https://ref.xht03.online/202505292007462.png)

## 因子分解

在介绍概率无向图的因子分解之前，我们先介绍**团与最大团**。

- 在无向图 $G$ 中，任何两个结点均有边连接的结点子集称为**团（Clique）**。

- 若 $C$ 是无向图 $G$ 的一个团，且不能再添加任何一个结点使其称为更大的团，则称 $C$ 是无向图 $G$ 的一个**最大团（Maximal Clique）**。

则概率无向图的因子分解由 Hammersley-Clifford 定理保证。该定理指出，若 $P(Y)$ 是一个无向图 $G$ 的联合分布，则它可以表示为所有最大团的势函数的乘积。

概率无向图的联合分布 $P(Y)$ 可以表示为如下形式：

$$
P(Y) = \frac{1}{Z} \prod_{C} \Phi_C(Y_C)
$$

$$
Z = \sum_{Y} \prod_{C} \Phi_C(Y_C)
$$

其中：

- $C$ 是无向图 $G$ 的最大团。

- $Y_C$ 是团 $C$ 对应的随机变量。

- $\Phi_C(Y_C)$ 是 $C$ 上定义的严格正函数，称为**势函数（Potential Function）**，常用**指数函数**表示。

- $Z$ 是规范化因子，保证 $P(Y)$ 是一个概率分布。

- 乘积是在无向图上所有的最大团 $C$ 上进行的。

## 参数化形式

对于线性链条件随机场，最大团就是一对对相邻结点，其因子分解式就是相邻结点的势函数的乘积。

设 P(Y|X) 是一个线性链条件随机场，则在随机变量 $X=x$ 条件下，随机变量 $Y$ 取值为 $y$ 的概率分布可以表示为：

$$
P(y \mid x) = \frac{1}{Z(x)} \prod_{i=1}^{n} \exp \left( \sum_{i,k} \lambda_k t_k(y_i, y_{i-1}, x, i) + \sum_{i,l} \mu_l s_l(y_i, x, i) \right)
$$

其中：

| **符号**               | **含义**                                                                 |
|------------------------|-------------------------------------------------------------------------|
| $X = x$            | 输入观测序列（如句子中的单词序列），长度为 $n$ 。                                 |
| $Y = y$            | 输出标签序列（如BIOES标注），与 $x$ 一一对应。                                   |
| $Z(x)$             | **归一化因子**，确保所有可能的 $y$ 的概率和为1                                  |
| $t_k(y_i, y_{i-1}, x, i)$ | **转移特征函数**，捕捉相邻标签 $y_{i-1}$ 和 $y_i$ 的依赖关系。            |
| $s_l(y_i, x, i)$   | **状态特征函数**，捕捉当前标签 $y_i$ 与观测序列 $x$ 的关系。                      |
| $\lambda_k, \mu_l$ | **权重参数**，分别对应转移特征和状态特征的权重，通过训练数据学习得到。               |
| $n$                | 序列长度（即单词或标签的数量）。                                                 |

## 简化形式

显然，上述线性链条件随机场的参数化形式太过复杂。我们可以对其进行简化。

其指数部分实际上就是（转移/状态）特征函数的加权求和。所以，我们希望将指数部分简化为 $w \cdot f(y, x)$ 的形式，其中 $w$ 是权重向量，$f(y, x)$ 是特征函数向量。

首先，将转移特征、状态特征函数、以及它们的权重用统一符号表示。

设有 $K_1$ 个转移特征函数，$K_2$ 个状态特征函数，总共 $K=K_1 + K_2$ 个特征函数，则定义：

$$
f_k(y_i, y_{i-1}, x, i) = 
\begin{cases}
t_k(y_i, y_{i-1}, x, i) &  k = 1, \ldots, K_1 \\
s_l(y_i, x, i) &  k = K_1 + l; \quad l = 1, 2, \cdots, K_2
\end{cases}
$$

$$
w_k =
\begin{cases}
\lambda_k &  k = 1, \ldots, K_1 \\
\mu_l &  k = K_1 + l; l = 1, 2, \cdots, K_2
\end{cases}
$$

我们将转移与状态特征在各个位置 $i$ 求和，记为：

$$
f_k(y,x) = \sum_{i=1}^{n} f_k(y_i, y_{i-1}, x, i), \quad k = 1, \ldots, K_1 + K_2
$$

那么，条件随机场可以表示为：

$$
P(y \mid x) = \frac{1}{Z(x)} \exp(\sum_{k=1}^{K}w_k f_k(y, x))
$$

也就是：

$$
P(y \mid x) = \frac{1}{Z(x)} \exp(w \cdot F(y, x))
$$

$$
Z(x) = \sum_{y} \exp(w \cdot F(y, x))
$$

其中 $F(y, x) = (f_1(y, x), f_2(y, x), \ldots, f_K(y, x))$ 是全局特征向量。

## 前向-后向算法








